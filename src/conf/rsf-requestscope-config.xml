<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" 
	"http://www.springframework.org/dtd/spring-beans.dtd">
<beans>
  <!-- This file contains request scope beans which are specific to RSF -->

  <!-- A request scope bean locator locating beans from THIS container! -->
  <bean id="requestBeanLocator" factory-bean="RSACBeanLocator"
    factory-method="getBeanLocator">
  </bean>

  <bean id="deadRequestBeanLocator" factory-bean="RSACBeanLocator"
    factory-method="getDeadBeanLocator">
  </bean>

  <bean id="httpServletFactory"
    class="uk.org.ponder.rsac.servlet.HttpServletFactory">
  </bean>

  <bean id="httpServletRequest" factory-bean="httpServletFactory"
    factory-method="getHttpServletRequest" />

  <bean id="httpServletResponse" factory-bean="httpServletFactory"
    factory-method="getHttpServletResponse" />

  <bean id="earlyRequestParser"
    class="uk.org.ponder.rsf.servlet.ServletEarlyRequestParser"
    init-method="init">
    <property name="httpServletRequest" ref="httpServletRequest" />
    <property name="multipartResolver" ref="multipartResolver" />
  </bean>

  <bean id="requestMap" factory-bean="earlyRequestParser"
    factory-method="getRequestMap" />

  <bean id="requestPathInfo" factory-bean="earlyRequestParser"
    factory-method="getPathInfo" />

  <bean id="requestType" factory-bean="earlyRequestParser"
    factory-method="getRequestType" />

  <bean id="multipartMap" factory-bean="earlyRequestParser"
    factory-method="getMultipartMap" />

  <!-- This bean may be overriden with your default view, in reduced form
    beginning with /  , otherwise it will be inferred from a view which reports
    itself as a default. Do not try to get the value of this bean as an
    application-scope dependency -->
  <bean id="defaultView" factory-bean="viewParametersParser"
    factory-method="getDefaultView" />

  <bean id="handlerResolver"
    class="uk.org.ponder.rsf.processor.DefaultHandlerResolver">
    <property name="renderHandler" ref="RSFRenderHandler" />
    <property name="actionHandler" ref="RSFActionHandler" />
  </bean>

  <bean id="renderSystem" factory-bean="renderSystemResolver"
    factory-method="getRenderSystem" />

  <bean id="contentTypeInfo" factory-bean="contentTypeInfoFactory"
    factory-method="getContentTypeInfo" />

  <bean id="renderHandler" factory-bean="handlerResolver"
    factory-method="getRenderHandler" />
  <bean id="actionHandler" factory-bean="handlerResolver"
    factory-method="getActionHandler" />

  <bean id="autoBaseURLProvider"
    class="uk.org.ponder.rsf.servlet.AutoBaseURLProvider" init-method="init">
    <property name="httpServletRequest">
      <ref bean="httpServletRequestProxy" />
    </property>
  </bean>

  <!--  This bean can go away once we implement parent factories and bean references -->
  <bean id="handlerHook" class="uk.org.ponder.rsf.processor.NullHandlerHook">
  </bean>

  <bean id="rootHandlerBeanBase" abstract="true"
    class="uk.org.ponder.rsf.servlet.RootHandlerBean" init-method="handle">
    <property name="requestType" ref="requestType" />
    <property name="viewStateHandler" ref="viewStateHandler" />
    <property name="outgoingParams" ref="outgoingParams" />
    <property name="renderHandlerBracketer" ref="renderHandlerBracketer" />
    <property name="actionHandler" ref="actionHandler" />
    <property name="handlerHook" ref="handlerHook" />
    <property name="contentTypeInfo" ref="contentTypeInfo" />
    <property name="fatalErrorHandler" ref="fatalErrorHandler" />
  </bean>

  <bean id="rootHandlerBean" parent="rootHandlerBeanBase">
    <property name="httpServletRequest" ref="httpServletRequest" />
    <property name="httpServletResponse" ref="httpServletResponse" />
  </bean>

  <!-- An uncensored BeanLocator suitable to be the target of internal EL
    expressions, filled out with any fallback beans -->
  <bean id="ELTargetBeanLocator"
    class="uk.org.ponder.beanutil.FallbackCapableBeanLocator">
    <property name="beanLocator" ref="requestBeanLocator" />
    <property name="fallbackBeans" ref="fallbackBeans" />
  </bean>

  <!-- The "censored" bean locator into which it is safe to resolve EL
    expressions coming in over the request -->
  <bean id="RSACSafeBeanLocator"
    class="uk.org.ponder.beanutil.SecuredBeanLocator">
    <property name="beanLocator" ref="ELTargetBeanLocator" />
    <property name="permittedBeanRoots" ref="totalRequestAddressibleBeans" />
  </bean>

  <bean id="ELEvaluator" class="uk.org.ponder.beanutil.ELEvaluator">
    <property name="beanLocator" ref="RSACSafeBeanLocator" />
    <property name="beanModelAlterer" ref="DARApplier" />
  </bean>

<!-- The ViewParameters object giving rise to the current request. Highly
  polymorphic, in general of some user-defined type. -->
  <bean id="viewParameters"
    class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
    <property name="singleton" value="true" />
    <property name="targetObject" ref="viewParametersParser" />
    <property name="targetMethod" value="parse" />
    <property name="arguments">
      <list>
        <ref local="requestPathInfo" />
        <ref local="requestMap" />
      </list>
    </property>
  </bean>

  <bean id="postDecoder" class="uk.org.ponder.rsf.processor.PostDecoder"
    init-method="init">
    <property name="renderSystemDecoder" ref="renderSystem" />
    <property name="requestMap" ref="requestMap" />
    <property name="requestType" ref="requestType" />
    <property name="fossilizedConverter" ref="fossilizedConverter" />
    <!-- WE CAN'T DELIVER THIS DEPENDENCY RIGHT NOW - circularity with
      PostDecoder. Crikey ESM is a heap of rubbish.
      <property name="errorStateManager" ref="errorStateManager"/>
    -->
  </bean>

  <bean id="normalizedRequest" factory-bean="postDecoder"
    factory-method="getNormalizedRequest" />

  <bean id="outgoingMap" class="java.util.HashMap"></bean>

  <!-- Marked as lazy-init because of late use from errorStateManager -->
  <bean id="requestRSVC" factory-bean="postDecoder"
    factory-method="getRequestRSVC" />

  <bean id="versionCheckPolicy"
    class="uk.org.ponder.rsf.state.NullVersionCheckPolicy" />


  <bean id="beanInvalidationModel"
    class="uk.org.ponder.mapping.ListBeanInvalidationModel" />

  <bean id="RSVCApplier" class="uk.org.ponder.rsf.state.RSVCApplier">
    <property name="versionCheckPolicy" ref="versionCheckPolicy" />
    <property name="rootBeanLocator" ref="RSACSafeBeanLocator" />
    <property name="beanModelAlterer" ref="DARApplier" />
    <property name="beanInvalidationModel" ref="beanInvalidationModel" />
    <property name="beanGuardProcessor" ref="beanGuardProcessor" />
    <property name="ignoreFossilizedValues" ref="ignoreFossilizedValues" />
    <property name="targettedMessageList" ref="targettedMessageList"/>
  </bean>

  <!--  requires input of requestRSVC in order to fix up errors at the
    end of a cycle -->
  <bean id="errorStateManager" class="uk.org.ponder.rsf.state.ErrorStateManager"
    init-method="init">
    <property name="TSHolder" ref="bandgapStateHolder" />
    <property name="viewParameters" ref="viewParameters" />
    <property name="requestRSVC" ref="requestRSVC" />
  </bean>

  <bean id="statePreservationManager"
    class="uk.org.ponder.rsf.preservation.StatePreservationManager">
    <property name="strategies" ref="statePreservationStrategies" />
    <property name="startFlowStrategies"
      ref="startFlowStatePreservationStrategies" />
    <property name="endFlowStrategies" ref="endFlowStatePreservationStrategies" />
    <property name="writeableBeanLocator" ref="ELTargetBeanLocator" />
    <property name="deadBeanLocator" ref="deadRequestBeanLocator" />
    <property name="scopeStrategies" ref="scopePreservationStrategies" />
  </bean>

  <bean id="scopeLocks" factory-bean="statePreservationManager"
    factory-method="getScopeLocks" lazy-init="true" />

  <bean name="outgoingParams"
    class="uk.org.ponder.rsf.components.ParameterList">
  </bean>

  <!-- A set of static renderers to be used for this request -->
  <!-- TODO: this should really be at app scope, with a proxy for consumer -->
  <bean id="staticRenderers"
    class="uk.org.ponder.rsf.renderer.scr.StaticRendererCollection">
    <property name="staticRenderers">
      <list>
        <ref bean="URLRewriteSCR" />
        <ref bean="headCollectSCR" />
        <ref bean="nullSCR"/>
        <ref bean="consumerStaticRenderers" />
      </list>
    </property>
  </bean>

  <!-- Given a TemplateResolver and a ViewParameters object, the Template
    LoaderBean returns a template. This is a factory bean -->
  <!-- Get rid of this and turn the TemplateResolver itself into a 
    request-scope bean -->
  <bean id="viewTemplate"
    class="uk.org.ponder.rsf.templateresolver.TemplateLoaderBean">
    <!-- EXTERNAL DEPENDENCY! The application supplies the template resolver -->
    <property name="templateResolver" ref="viewTemplateResolver" />
    <property name="viewParameters" ref="viewParameters" />
  </bean>

  <bean id="viewRender" class="uk.org.ponder.rsf.renderer.ViewRender">
    <property name="viewTemplate" ref="viewTemplate" />
    <property name="contentTypeInfo" ref="contentTypeInfo" />
    <!-- This dependence is injected manually, since the alterationwrapper must
      bracket restoration, and access to the model by fixup -->
    <!--
      <property name="view">
      <ref local="view"/>
      </property>-->
    <property name="renderSystem" ref="renderSystem" />
    <property name="messageRenderer" ref="messageRenderer" />
    <property name="decoratorManager" ref="decoratorManager" />
  </bean>

  <bean id="flowStateManager" class="uk.org.ponder.rsf.flow.FlowStateManager">
    <property name="errorStateManager" ref="errorStateManager" />
    <property name="statePreservationManager" ref="statePreservationManager" />
  </bean>

  <bean id="RSFActionHandler"
    class="uk.org.ponder.rsf.processor.RSFActionHandler" lazy-init="true">
    <property name="errorStateManager" ref="errorStateManager" />
    <property name="ARIResolver" ref="ARIResolver" />
    <property name="viewParameters" ref="viewParameters" />
    <property name="requestRSVC" ref="requestRSVC" />
    <property name="alterationWrapper" ref="alterationWrapper" />
    <property name="RSVCApplier" ref="RSVCApplier" />
    <property name="normalizedRequestMap" ref="normalizedRequest" />
    <property name="statePreservationManager" ref="statePreservationManager" />
    <property name="viewExceptionStrategy" ref="viewExceptionStrategy" />
    <property name="actionErrorStrategy" ref="actionErrorStrategyManager" />
    <property name="flowStateManager" ref="flowStateManager" />
    <property name="targettedMessageList" ref="targettedMessageList" />
  </bean>

  <bean id="ARIResult" factory-bean="actionHandler"
    factory-method="getARIResult" lazy-init="true" />
  <!-- A useful "EL-target" bean to allow scopes to be destroyed via EL -->
  <bean id="destroyScope"
    class="uk.org.ponder.rsf.state.scope.ScopedBeanDestroyer" />

  <bean id="destroyedScopeMap" class="java.util.HashMap" />

  <!-- Begin beans for FlowLite -->

  <bean id="flowLite-flowIDHolder"
    class="uk.org.ponder.rsf.flow.FlowIDHolder">
  </bean>

  <bean id="flowLite-flowProxyBean"
    class="uk.org.ponder.rsf.flow.lite.FlowActionProxyBean" abstract="true">
    <property name="reflectiveCache" ref="reflectiveCache" />
    <property name="beanLocator" ref="requestBeanLocator" />
    <property name="viewParameters" ref="viewParameters" />
    <property name="flowIDHolder" ref="flowLite-flowIDHolder" />
    <property name="errorHandler" ref="actionHandler" />
  </bean>

  <!-- End beans for FlowLite -->

  <bean id="pageBasicProducer"
    class="org.springframework.beans.factory.config.BeanReferenceFactoryBean">
    <property name="targetBeanName" value="viewCollector" />
  </bean>

  <!-- Collects together all ViewProducers, and selects those appropriate for 
    this request -->
  <bean id="viewCollector" class="uk.org.ponder.rsf.view.ViewCollector">
    <property name="viewResolver" ref="viewResolver" />
    <property name="viewParameters" ref="viewParameters" />
    <property name="componentChecker" ref="viewTemplate" />
  </bean>

  <bean id="viewGenerator" class="uk.org.ponder.rsf.view.ViewGenerator">
    <!-- The default pageProducer is the ViewCollection -->
    <property name="pageProducer" ref="pageProducer" />
    <property name="navigationCaseReceiver" ref="navigationCasePooler" />
    <property name="XMLProvider" ref="XMLProvider" />
  </bean>
  <!--
    <bean id="view" factory-bean="viewgenerator" factory-method="getView"/>
  -->

  <!-- Begin request scope "fixer" beans - manipulate component tree in between
    generation and rendering -->

  <bean id="formFixer"
    class="uk.org.ponder.rsf.componentprocessor.DefaultFormFixer">
    <property name="viewParameters" ref="viewParameters" />
    <property name="viewStateHandler" ref="viewStateHandler" />
    <property name="URLRewriter" ref="URLRewriter" />
    <property name="outgoingParams" ref="outgoingParams" />
    <property name="internalURLRewriter" ref="internalURLRewriter" />
  </bean>

  <bean id="valueFixer"
    class="uk.org.ponder.rsf.componentprocessor.ValueFixer">
    <property name="beanLocator" ref="ELTargetBeanLocator" />
    <property name="modelAlterer" ref="DARApplier" />
    <property name="fossilizedConverter" ref="fossilizedConverter" />
    <property name="errorStateManager" ref="errorStateManager" />
    <property name="renderFossilizedForms" ref="renderFossilizedForms" />
  </bean>

  <!-- End "fixer" beans" -->

  <bean id="viewProcessor"
    class="uk.org.ponder.rsf.componentprocessor.ViewProcessor">
    <property name="mappingContext" ref="ELMappingContext" />
    <property name="componentProcessors">
      <list>
        <!-- This must execute before formfixer-->
        <ref bean="containmentFormFixer" />
        <ref bean="formFixer" />
        <ref bean="viewParamsFixer" />
        <ref bean="messageFixer" />
        <ref bean="bindingFixer" />
        <ref bean="valueFixer" />
      </list>
    </property>
  </bean>

  <bean id="renderHandlerBracketer"
    class="uk.org.ponder.rsf.processor.RenderHandlerBracketer"
    lazy-init="true">
    <property name="errorStateManager" ref="errorStateManager" />
    <property name="viewExceptionStrategy" ref="viewExceptionStrategy" />
    <property name="viewParameters" ref="viewParameters" />
    <property name="renderHandler" ref="renderHandler" />
    <property name="redirectOnLevel1Error" ref="redirectOnLevel1Error" />
  </bean>

  <!-- achieve two things here with laziness - renderHandler is not resolved in non-POST requests,
    and ALSO is not resolved until first use, to allow exception bracketing -->
  <bean id="RSFRenderHandler"
    class="uk.org.ponder.rsf.processor.RSFRenderHandler" lazy-init="true">
    <property name="errorStateManager" ref="errorStateManager" />
    <property name="viewParameters" ref="viewParameters" />
    <property name="viewGenerator" ref="viewGenerator" />
    <property name="alterationWrapper" ref="alterationWrapper" />
    <property name="statePreservationManager" ref="statePreservationManager" />
    <property name="viewProcessor" ref="viewProcessor" />
    <property name="viewRender" ref="viewRender" />
    <property name="targettedMessageList" ref="targettedMessageList" />
  </bean>
  
  <!-- Beans for UVB (the Universal View Bus) -->
  
  <bean id="UVBBean" class="uk.org.ponder.rsf.builtin.UVBBean">
    <property name="requestBeanGetter" ref="ELEvaluator"/>
  </bean>
  
  <bean id="UVBView" class="uk.org.ponder.rsf.builtin.UVBProducer">
    <property name="UVBBean" ref="UVBBean"/>
    <property name="beanDestroyer" ref="UVBScope"/>
  </bean>
</beans>